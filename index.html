<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🧠 Strain Game</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
  input, button { font-size: 1rem; padding: 0.5rem; margin: 0.3rem 0; }
  #usernameInput { width: 100%; max-width: 300px; }
  #wordInput { width: 100%; max-width: 200px; }
  #wordList { margin-top: 1rem; padding-left: 20px; }
  #yesterdaySection { margin-top: 2rem; border-top: 1px solid #ccc; padding-top: 1rem; }
</style>
</head>
<body>

<h1>🧠 Strain Game</h1>

<label for="usernameInput">Enter your name:</label>
<input type="text" id="usernameInput" placeholder="Your name" maxlength="20" />

<div id="game">
  <!-- Game UI will be loaded here -->
</div>

<div id="controls" style="margin-top: 1rem;">
  <button onclick="loadGame()">🔁 Restart</button>
  <button onclick="loadYesterday()">📅 Yesterday's Puzzle</button>
  <button onclick="showLeaderboard()">🏆 Leaderboard</button>
  <button onclick="generateChallengeLink()">🎯 Challenge a Friend</button>
</div>

<div id="yesterdaySection">
  <h3>Yesterday's Puzzle</h3>
  <div id="yesterdayInfo">Loading...</div>
  <button id="loadYesterdayBtn">Load Yesterday's Game</button>
</div>

<textarea id="share-output" readonly rows="4" style="width:100%; margin-top:1rem;"></textarea>
<button onclick="copyToClipboard(document.getElementById('share-output').value)">📤 Copy Shareable Result</button>

<script>
// --- Utilities ---

function getTodayDateKey(offset = 0) {
  const today = new Date();
  today.setDate(today.getDate() + offset);
  return today.toISOString().split("T")[0];
}

function saveGameResult(dateKey, result) {
  localStorage.setItem(`result-${dateKey}`, JSON.stringify(result));
}

function getGameResult(dateKey) {
  return JSON.parse(localStorage.getItem(`result-${dateKey}`));
}

function updateStreak() {
  const today = getTodayDateKey();
  const yesterday = getTodayDateKey(-1);
  const yesterdayResult = getGameResult(yesterday);
  let streak = parseInt(localStorage.getItem("streak") || "0");

  if (yesterdayResult && !getGameResult(today)) {
    streak++;
  } else if (!yesterdayResult) {
    streak = 1;
  }
  localStorage.setItem("streak", streak);
  // Optionally update streak display if added to UI
}

function addLeaderboardEntry(name, guesses, time) {
  const leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  leaderboard.push({ name, guesses, time });
  localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
}

function showLeaderboard() {
  const leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  if (leaderboard.length === 0) {
    alert("No leaderboard entries yet.");
    return;
  }
  leaderboard.sort((a, b) => a.time - b.time);
  const list = leaderboard.map(e => `${e.name}: ${e.guesses} guesses, ${e.time}s`).join("\n");
  alert("🏆 Leaderboard:\n" + list);
}

function generateShareText(result) {
  const emojiMap = ["⬛️", "🟨", "🟩"];
  const lines = result.path.map(word => {
    return word.split("").map(() => emojiMap[Math.floor(Math.random() * 3)]).join("");
  });
  lines.push(`🎉 Solved in ${result.path.length} guesses!`);
  lines.push("Play: https://MattyBoy22.github.io/strain-game/");
  return lines.join("\n");
}

function copyToClipboard(text) {
  if (!text) return alert("Nothing to copy!");
  navigator.clipboard.writeText(text);
  alert("📋 Result copied to clipboard!");
}

// --- Game logic ---

const usernameInput = document.getElementById("usernameInput");
let playerName = localStorage.getItem("playerName") || "";
usernameInput.value = playerName;

usernameInput.addEventListener("keyup", (e) => {
  if (e.key === "Enter") {
    const name = usernameInput.value.trim();
    if (name.length === 0) {
      alert("Please enter a valid name");
      return;
    }
    playerName = name;
    localStorage.setItem("playerName", playerName);
    alert(`Username set to: ${playerName}`);
  }
});

function loadPuzzle(dateKey = getTodayDateKey()) {
  // Check for custom puzzle params here if needed

  const wordPairs = [
    ["stain", "brain"],
    ["start", "crate"],
    ["plant", "grape"],
    ["sword", "stone"],
    ["chair", "table"]
  ];
  const seed = new Date(dateKey).getDate() % wordPairs.length;
  return { dateKey, start: wordPairs[seed][0], end: wordPairs[seed][1] };
}

function loadYesterday() {
  loadGame(getTodayDateKey(-1));
}

function loadGame(dateKey = getTodayDateKey()) {
  const puzzle = loadPuzzle(dateKey);
  const gameEl = document.getElementById("game");
  gameEl.innerHTML = `
    <p>Transform <b>${puzzle.start}</b> → <b>${puzzle.end}</b> one letter at a time</p>
    <input id='wordInput' maxlength="5" placeholder="Enter 5-letter word" />
    <button onclick='submitWord()'>Submit</button>
    <ul id='wordList'></ul>
  `;

  const inputEl = document.getElementById("wordInput");
  inputEl.focus();
  inputEl.addEventListener("keyup", function (e) {
    if (e.key === "Enter") submitWord();
  });

  const path = [];
  const start = puzzle.start;
  const end = puzzle.end;

  function isOneLetterDifferent(w1, w2) {
    if (w1.length !== w2.length) return false;
    let diff = 0;
    for (let i = 0; i < w1.length; i++) if (w1[i] !== w2[i]) diff++;
    return diff === 1;
  }

  window.submitWord = function () {
    const word = inputEl.value.trim().toLowerCase();
    if (path.length === 0 && word !== start) return alert("Start with the first word: " + start);
    if (!/^[a-zA-Z]{5}$/.test(word)) return alert("Word must be exactly 5 letters");
    if (path.length > 0 && !isOneLetterDifferent(path[path.length - 1], word)) return alert("Change exactly one letter");
    path.push(word);
    const wordListEl = document.getElementById("wordList");
    wordListEl.innerHTML += `<li>${word}</li>`;
    inputEl.value = "";
    inputEl.focus();

    if (word === end) {
      const result = { dateKey: puzzle.dateKey, path };
      saveGameResult(puzzle.dateKey, result);
      updateStreak();
      addLeaderboardEntry(playerName || "Anonymous", path.length, path.length * 5);
      document.getElementById("share-output").value = generateShareText(result);
      alert("🎉 You solved it! Results ready to share.");
    }
  };

  updateStreak();
}

// Yesterday's Puzzle Section
function displayYesterday() {
  const yesterdayKey = getTodayDateKey(-1);
  const yesterdayResult = getGameResult(yesterdayKey);
  const yesterdayInfo = document.getElementById("yesterdayInfo");

  if (!yesterdayResult) {
    yesterdayInfo.textContent = "You did not play yesterday’s puzzle.";
  } else {
    yesterdayInfo.innerHTML = `
      Puzzle Date: ${yesterdayKey}<br>
      Guesses: ${yesterdayResult.path.length}<br>
      Words: ${yesterdayResult.path.join(", ")}
    `;
  }
}

document.getElementById("loadYesterdayBtn").addEventListener("click", () => {
  loadGame(getTodayDateKey(-1));
});

// Challenge link logic (from your existing code)
function generateChallengeLink() {
  const today = getTodayDateKey();
  const url = new URL(window.location);
  url.searchParams.set("date", today);
  prompt("🔗 Share this challenge link:", url.toString());
}

// Init
window.onload = () => {
  displayYesterday();
  loadGame();
};
</script>

</body>
</html>
